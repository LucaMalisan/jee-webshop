<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ArticleController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jee-webshop</a> &gt; <a href="index.source.html" class="el_package">src.controller</a> &gt; <span class="el_source">ArticleController.java</span></div><h1>ArticleController.java</h1><pre class="source lang-java linenums">package src.controller;

import jakarta.enterprise.context.RequestScoped;
import jakarta.inject.Inject;
import jakarta.inject.Named;
import jakarta.servlet.http.HttpServletRequest;

import java.util.List;
import java.util.stream.Collectors;
import java.util.stream.IntStream;
import lombok.Getter;
import src.model.Article;
import src.repository.ArticleRepository;

@Named
@RequestScoped
@SuppressWarnings(&quot;unused&quot;)
public class ArticleController {

  private ArticleRepository repository;

<span class="nc" id="L22">  public ArticleController() {}</span>

  @Inject
<span class="fc" id="L25">  public ArticleController(ArticleRepository repository) {</span>
<span class="fc" id="L26">    this.repository = repository;</span>
<span class="fc" id="L27">  }</span>

<span class="fc" id="L29">  @Getter private Article articleDetail;</span>
<span class="nc" id="L30">  @Getter private List&lt;Article&gt; articles;</span>
<span class="fc" id="L31">  @Getter private static final double PAGE_SIZE = 12;</span>

  /**
   * Calculates the highest page available based upon the result set of articles
   *
   * @return highest available page
   */
  public int getTotalPageCount(HttpServletRequest request) {
<span class="fc" id="L39">    List&lt;Article&gt; articles = getAllArticlesByRequest(request);</span>
<span class="fc bfc" id="L40" title="All 2 branches covered.">    return articles == null ? 1 : (int) Math.max(Math.ceil(articles.size() / PAGE_SIZE), 1);</span>
  }

  /**
   * Queries articles from the database respecting given filters and applies pagination
   *
   * @param request: HttpServletRequest
   * @return result set of corresponding page
   */
  public List&lt;Article&gt; getPagedArticles(HttpServletRequest request) {
<span class="fc" id="L50">    int page = this.getPageByRequest(request);</span>
<span class="fc" id="L51">    List&lt;Article&gt; articles = getAllArticlesByRequest(request);</span>

<span class="fc" id="L53">    return articles.subList(</span>
<span class="fc" id="L54">        this.calcSublistStartIndex(page), this.calcSublistEndIndex(page, articles.size()));</span>
  }

  /**
   * Calculates the page numbers to be shown in the navigation pane, based on given count. The page
   * numbers should cover the spectrum around the given page in the interval [2 ; totalPageCount -
   * 1] If the page total count is too small, only give as many numbers as possible
   *
   * @param request: HttpServletRequest
   * @param count: how many page numbers should be shown
   * @return list with calculated page numbers
   */
  public List&lt;Integer&gt; getPageNumbers(HttpServletRequest request, int count) {
<span class="fc" id="L67">    int page = this.getPageByRequest(request);</span>
<span class="fc" id="L68">    int correctCount = Math.min(count, this.getTotalPageCount(request) - 2);</span>

    // lowest page number must at least be 2
<span class="fc" id="L71">    int lowestNumber = Math.max(2, page - 1);</span>

    // highest number should have a distance of &lt;count&gt; to lowest number, but mustn't exceed total
    // page count
<span class="fc" id="L75">    int highestNumber = Math.min(lowestNumber + correctCount, this.getTotalPageCount(request));</span>

    // re-calculation based on calculated highest number
<span class="fc" id="L78">    lowestNumber = highestNumber - correctCount;</span>

<span class="fc" id="L80">    return IntStream.range(lowestNumber, lowestNumber + correctCount)</span>
<span class="fc" id="L81">        .boxed()</span>
<span class="fc" id="L82">        .collect(Collectors.toList());</span>
  }

  public boolean existsPreviousPage(HttpServletRequest request) {
<span class="fc bfc" id="L86" title="All 2 branches covered.">    return this.getPageByRequest(request) &gt; 1;</span>
  }

  public boolean existsNextPage(HttpServletRequest request) {
<span class="fc bfc" id="L90" title="All 2 branches covered.">    return this.getPageByRequest(request) &lt; this.getTotalPageCount(request);</span>
  }

  /**
   * Use to cache article-detail to retrieve it later from JSF
   *
   * @param request: request
   */
  public void setArticleDetail(HttpServletRequest request) {
<span class="fc" id="L99">    long sku = Long.parseLong(request.getParameter(&quot;sku&quot;));</span>
<span class="fc" id="L100">    this.articleDetail = repository.findBySku(sku);</span>
<span class="fc" id="L101">  }</span>

  /**
   * Parse page out of request and fix invalid values
   *
   * @param request: HttpServletRequest
   * @return parsed page number
   */
  private int getPageByRequest(HttpServletRequest request) {
<span class="fc" id="L110">    int page = 1; // fallback value if parsing fails</span>

    try {
<span class="fc" id="L113">      page = Integer.parseInt(request.getParameter(&quot;page&quot;));</span>
<span class="fc" id="L114">    } catch (Exception ignored) {</span>
<span class="fc" id="L115">    }</span>

    // page mustn't exceed total page count
<span class="fc" id="L118">    page = Math.min(page, this.getTotalPageCount(request));</span>

    // return parsed page, but it must be at least 1
<span class="fc" id="L121">    return Math.max(page, 1);</span>
  }

  /**
   * Parses the search form data out of the request
   *
   * @param request: request
   * @return list of matching articles
   */
  List&lt;Article&gt; getAllArticlesByRequest(HttpServletRequest request) {
<span class="fc" id="L131">    String categoryUuid = request.getParameter(&quot;categoryUuid&quot;);</span>
<span class="fc" id="L132">    String subcategoryUuid = request.getParameter(&quot;subcategoryUuid&quot;);</span>
<span class="fc" id="L133">    String query = request.getParameter(&quot;query&quot;);</span>

<span class="fc" id="L135">    return repository.getArticles(categoryUuid, subcategoryUuid, query);</span>
  }

  /**
   * Used formula &lt;code&gt; (page - 1) * PAGE_SIZE &lt;/code&gt; corresponding to (page=1 -&gt; index=0,
   * page=2-&gt; index=12, ...)
   *
   * @param page: current page
   * @return startIndex for sublist based on page size
   */
  private int calcSublistStartIndex(int page) {
<span class="fc" id="L146">    return (int) ((page - 1) * PAGE_SIZE);</span>
  }

  /**
   * Used formula &lt;code&gt; Math.min(totalListSize, page * PAGE_SIZE) &lt;/code&gt;; if calculated page
   * exceeds list size, restrict end index to list size
   *
   * @param page: current page
   * @return endIndex for sublist based on page size
   */
  private int calcSublistEndIndex(int page, int totalListSize) {
<span class="fc" id="L157">    return (int) (Math.min(totalListSize, page * PAGE_SIZE));</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>