<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ShoppingCartController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jee-webshop</a> &gt; <a href="index.source.html" class="el_package">src.controller</a> &gt; <span class="el_source">ShoppingCartController.java</span></div><h1>ShoppingCartController.java</h1><pre class="source lang-java linenums">package src.controller;

import jakarta.enterprise.context.RequestScoped;
import jakarta.inject.Inject;
import jakarta.inject.Named;
import jakarta.servlet.http.HttpServletRequest;
import java.util.ArrayList;
import java.util.List;
import java.util.UUID;
import lombok.Getter;
import lombok.NoArgsConstructor;
import src.model.Article;
import src.model.ShoppingCart;
import src.repository.ArticleRepository;
import src.repository.ShoppingCartRepository;

@Getter
@Named
@RequestScoped
@SuppressWarnings(&quot;unused&quot;)
<span class="nc" id="L21">@NoArgsConstructor</span>
public class ShoppingCartController {

<span class="nc" id="L24">  @Inject private ShoppingCartRepository shoppingCartRepository;</span>
<span class="nc" id="L25">  @Inject private ArticleRepository articleRepository;</span>
<span class="nc" id="L26">  @Named @Inject private AuthController authController;</span>

  private static final double VAT = 0.07;

  public ShoppingCartController(
<span class="fc" id="L31">      ShoppingCartRepository shoppingCartRepository, AuthController authController) {</span>
<span class="fc" id="L32">    this.shoppingCartRepository = shoppingCartRepository;</span>
<span class="fc" id="L33">    this.authController = authController;</span>
<span class="fc" id="L34">  }</span>

  /**
   * Retrieve all shopping cart entires
   *
   * @param request request
   * @return list of shopping cart entries
   */
  public List&lt;ShoppingCart&gt; getShoppingCartEntries(HttpServletRequest request) {
<span class="fc" id="L43">    String email = authController.extractEmail(request);</span>

<span class="fc bfc" id="L45" title="All 2 branches covered.">    if (email == null) {</span>
<span class="fc" id="L46">      return new ArrayList&lt;&gt;();</span>
    }

<span class="fc" id="L49">    return shoppingCartRepository.getShoppingCartEntries(email);</span>
  }

  /**
   * Get price without VAT
   *
   * @param request requset
   * @return price without VAT
   */
  public String getPriceExclVat(HttpServletRequest request) {
<span class="fc" id="L59">    String email = new AuthController().extractEmail(request);</span>
<span class="fc" id="L60">    return String.format(&quot;%.2f CHF&quot;, shoppingCartRepository.getTotalPrice(email) * (1 - VAT));</span>
  }

  /**
   * Get VAT amount of price
   *
   * @param request request
   * @return VAT amount of price
   */
  public String getVat(HttpServletRequest request) {
<span class="fc" id="L70">    String email = new AuthController().extractEmail(request);</span>
<span class="fc" id="L71">    return String.format(&quot;%.2f CHF&quot;, shoppingCartRepository.getTotalPrice(email) * (VAT));</span>
  }

  /**
   * Get sum of price of all articles
   *
   * @param request request
   * @return sum of price of all articles
   */
  public String getTotal(HttpServletRequest request) {
<span class="fc" id="L81">    String email = new AuthController().extractEmail(request);</span>
<span class="fc" id="L82">    return String.format(&quot;%.2f CHF&quot;, shoppingCartRepository.getTotalPrice(email));</span>
  }

  /**
   * Get sum of discount of all articles
   *
   * @param request request
   * @return sum of discount of all articles
   */
  public String getDiscount(HttpServletRequest request) {
<span class="fc" id="L92">    String email = new AuthController().extractEmail(request);</span>
<span class="fc" id="L93">    return String.format(&quot;%.2f CHF&quot;, shoppingCartRepository.getTotalDiscount(email));</span>
  }

  public ShoppingCart getOrUpdateShoppingCart(long sku, long amount, String email) {
<span class="fc" id="L97">    Article article = articleRepository.findBySku(sku);</span>
<span class="fc" id="L98">    ShoppingCart shoppingCart = shoppingCartRepository.findBySkuAndEmail(sku, email);</span>
<span class="fc" id="L99">    amount = this.getMaxAmount(amount, article);</span>

    // if entry doesn't exist yet, create a new one
<span class="fc bfc" id="L102" title="All 2 branches covered.">    if (shoppingCart == null) {</span>
<span class="fc" id="L103">      shoppingCart = new ShoppingCart();</span>
<span class="fc" id="L104">      shoppingCart.setUuid(UUID.randomUUID().toString());</span>
<span class="fc" id="L105">      shoppingCart.setArticleSku(sku);</span>
<span class="fc" id="L106">      shoppingCart.setEmail(email);</span>
<span class="fc" id="L107">      shoppingCart.setAmount(amount);</span>
    } else {
      // if entry exists, increase amount
<span class="fc" id="L110">      shoppingCart.setAmount(shoppingCart.getAmount() + amount);</span>
    }

<span class="fc" id="L113">    return shoppingCart;</span>
  }

  /**
   * amount can't exceed current stock
   *
   * @param amount amount
   * @param shoppingCart model
   * @return max possible amount
   */
  public long getMaxAmount(long amount, ShoppingCart shoppingCart) {
<span class="fc" id="L124">    return this.getMaxAmount(amount, shoppingCart.getArticle());</span>
  }

  /**
   * amount can't exceed current stock
   *
   * @param amount amount
   * @param article model
   * @return max possible amount
   */
  public long getMaxAmount(long amount, Article article) {
<span class="fc" id="L135">    return Math.min(amount, article.getStock());</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>