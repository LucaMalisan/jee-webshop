<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ApiController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jee-webshop</a> &gt; <a href="index.source.html" class="el_package">src.controller</a> &gt; <span class="el_source">ApiController.java</span></div><h1>ApiController.java</h1><pre class="source lang-java linenums">package src.controller;

import com.auth0.AuthenticationController;
import com.auth0.IdentityVerificationException;
import com.auth0.Tokens;
import io.github.cromat.JavaxRequest;
import io.github.cromat.JavaxResponse;
import jakarta.enterprise.context.RequestScoped;
import jakarta.inject.Inject;
import jakarta.inject.Named;
import jakarta.servlet.http.Cookie;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import jakarta.ws.rs.*;
import jakarta.ws.rs.core.Context;
import jakarta.ws.rs.core.MediaType;
import jakarta.ws.rs.core.Response;
import jakarta.ws.rs.core.Response.Status;
import java.net.URI;
import java.net.URISyntaxException;
import java.util.UUID;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.transaction.Transactional;
import src.auth.Auth0AuthenticationConfig;
import src.auth.AuthMailSender;
import src.model.Article;
import src.model.ArticleImage;
import src.model.Category;
import src.model.ShoppingCart;
import src.model.Subcategory;
import src.model.User;
import src.repository.ArticleRepository;
import src.repository.CategoryRepository;
import src.repository.ShoppingCartRepository;
import src.repository.UserRepository;

/**
 * Central class for all REST api methods
 */

@RequestScoped
<span class="nc" id="L43">public class ApiController {</span>

  @Inject private ArticleRepository articleRepository;
  @Inject private CategoryRepository categoryRepository;
  @Inject private Auth0AuthenticationConfig config;
  @Inject private AuthenticationController authenticationController;
  @Inject private ShoppingCartController shoppingCartController;
  @Inject private UserRepository repository;
  @Inject private ShoppingCartRepository shoppingCartRepository;
  @Context private HttpServletRequest request;
  @Named @Inject private AuthController authController;

  // Article endpoints
  @POST
  @Path(&quot;/api/add-article&quot;)
  @Consumes(MediaType.APPLICATION_JSON)
  @Produces(MediaType.APPLICATION_JSON)
  public Response createArticle(Article article) {
    try {
<span class="nc" id="L62">      articleRepository.save(article);</span>
<span class="nc" id="L63">      return Response.status(Response.Status.CREATED).build();</span>
<span class="nc" id="L64">    } catch (Exception e) {</span>
<span class="nc" id="L65">      return Response.status(Response.Status.BAD_REQUEST)</span>
<span class="nc" id="L66">          .entity(&quot;Failed to create article: &quot; + e.getMessage())</span>
<span class="nc" id="L67">          .build();</span>
    }
  }

  @PUT
  @Path(&quot;/api/update-article&quot;)
  @Consumes(MediaType.APPLICATION_JSON)
  @Produces(MediaType.APPLICATION_JSON)
  public Response updateArticle(Article article) {
    try {
<span class="nc" id="L77">      articleRepository.merge(article);</span>
<span class="nc" id="L78">      return Response.status(Response.Status.OK).build();</span>
<span class="nc" id="L79">    } catch (Exception e) {</span>
<span class="nc" id="L80">      return Response.status(Response.Status.BAD_REQUEST)</span>
<span class="nc" id="L81">          .entity(&quot;Failed to update article: &quot; + e.getMessage())</span>
<span class="nc" id="L82">          .build();</span>
    }
  }

  @DELETE
  @Path(&quot;/api/delete-article/{sku}&quot;)
  @Consumes(MediaType.TEXT_PLAIN)
  @Produces(MediaType.APPLICATION_JSON)
  public Response deleteArticle(@PathParam(&quot;sku&quot;) String sku) {
    try {
<span class="nc" id="L92">      articleRepository.deleteBySku(sku);</span>
<span class="nc" id="L93">      return Response.status(Response.Status.OK).build();</span>
<span class="nc" id="L94">    } catch (Exception e) {</span>
<span class="nc" id="L95">      return Response.status(Response.Status.BAD_REQUEST)</span>
<span class="nc" id="L96">          .entity(&quot;Failed to delete article: &quot; + e.getMessage())</span>
<span class="nc" id="L97">          .build();</span>
    }
  }

  // Category endpoints
  @POST
  @Path(&quot;/api/add-category&quot;)
  @Consumes(MediaType.APPLICATION_JSON)
  @Produces(MediaType.APPLICATION_JSON)
  public Response createCategory(Category category) {
    try {
<span class="nc" id="L108">      categoryRepository.save(category);</span>
<span class="nc" id="L109">      return Response.status(Response.Status.CREATED).build();</span>
<span class="nc" id="L110">    } catch (Exception e) {</span>
<span class="nc" id="L111">      return Response.status(Response.Status.BAD_REQUEST)</span>
<span class="nc" id="L112">          .entity(&quot;Failed to create category: &quot; + e.getMessage())</span>
<span class="nc" id="L113">          .build();</span>
    }
  }

  @PUT
  @Path(&quot;/api/update-category&quot;)
  @Consumes(MediaType.APPLICATION_JSON)
  @Produces(MediaType.APPLICATION_JSON)
  public Response updateCategory(Category category) {
    try {
<span class="nc" id="L123">      categoryRepository.merge(category);</span>
<span class="nc" id="L124">      return Response.status(Response.Status.OK).build();</span>
<span class="nc" id="L125">    } catch (Exception e) {</span>
<span class="nc" id="L126">      return Response.status(Response.Status.BAD_REQUEST)</span>
<span class="nc" id="L127">          .entity(&quot;Failed to update category: &quot; + e.getMessage())</span>
<span class="nc" id="L128">          .build();</span>
    }
  }

  @DELETE
  @Path(&quot;/api/delete-category/{uuid}&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  public Response deleteCategory(@PathParam(&quot;uuid&quot;) String uuid) {
    try {
<span class="nc" id="L137">      categoryRepository.deleteByUuid(uuid);</span>
<span class="nc" id="L138">      return Response.status(Response.Status.OK).build();</span>
<span class="nc" id="L139">    } catch (Exception e) {</span>
<span class="nc" id="L140">      return Response.status(Response.Status.BAD_REQUEST)</span>
<span class="nc" id="L141">          .entity(&quot;Failed to delete category: &quot; + e.getMessage())</span>
<span class="nc" id="L142">          .build();</span>
    }
  }

  // Subcategory endpoints
  @POST
  @Path(&quot;/api/add-subcategory&quot;)
  @Consumes(MediaType.APPLICATION_JSON)
  @Produces(MediaType.APPLICATION_JSON)
  public Response createSubcategory(Subcategory subcategory) {
    try {
<span class="nc" id="L153">      categoryRepository.save(subcategory);</span>
<span class="nc" id="L154">      return Response.status(Response.Status.CREATED).build();</span>
<span class="nc" id="L155">    } catch (Exception e) {</span>
<span class="nc" id="L156">      return Response.status(Response.Status.BAD_REQUEST)</span>
<span class="nc" id="L157">          .entity(&quot;Failed to create subcategory: &quot; + e.getMessage())</span>
<span class="nc" id="L158">          .build();</span>
    }
  }

  @PUT
  @Path(&quot;/api/update-subcategory&quot;)
  @Consumes(MediaType.APPLICATION_JSON)
  @Produces(MediaType.APPLICATION_JSON)
  public Response updateSubcategory(Subcategory subcategory) {
    try {
<span class="nc" id="L168">      categoryRepository.merge(subcategory);</span>
<span class="nc" id="L169">      return Response.status(Response.Status.OK).build();</span>
<span class="nc" id="L170">    } catch (Exception e) {</span>
<span class="nc" id="L171">      return Response.status(Response.Status.BAD_REQUEST)</span>
<span class="nc" id="L172">          .entity(&quot;Failed to update subcategory: &quot; + e.getMessage())</span>
<span class="nc" id="L173">          .build();</span>
    }
  }

  @DELETE
  @Path(&quot;/api/delete-subcategory/{uuid}&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  public Response deleteSubcategory(@PathParam(&quot;uuid&quot;) String uuid) {
    try {
<span class="nc" id="L182">      categoryRepository.deleteBySubcategoryUuid(uuid);</span>
<span class="nc" id="L183">      return Response.status(Response.Status.OK).build();</span>
<span class="nc" id="L184">    } catch (Exception e) {</span>
<span class="nc" id="L185">      return Response.status(Response.Status.BAD_REQUEST)</span>
<span class="nc" id="L186">          .entity(&quot;Failed to delete subcategory: &quot; + e.getMessage())</span>
<span class="nc" id="L187">          .build();</span>
    }
  }

  // ArticleImage endpoints
  @POST
  @Path(&quot;/api/add-article-image&quot;)
  @Consumes(MediaType.APPLICATION_JSON)
  @Produces(MediaType.APPLICATION_JSON)
  public Response createArticleImage(ArticleImage articleImage) {
    try {
<span class="nc" id="L198">      articleRepository.save(articleImage);</span>
<span class="nc" id="L199">      return Response.status(Response.Status.CREATED).build();</span>
<span class="nc" id="L200">    } catch (Exception e) {</span>
<span class="nc" id="L201">      return Response.status(Response.Status.BAD_REQUEST)</span>
<span class="nc" id="L202">          .entity(&quot;Failed to create article image: &quot; + e.getMessage())</span>
<span class="nc" id="L203">          .build();</span>
    }
  }

  @PUT
  @Path(&quot;/api/update-article-image&quot;)
  @Consumes(MediaType.APPLICATION_JSON)
  @Produces(MediaType.APPLICATION_JSON)
  public Response updateArticleImage(ArticleImage articleImage) {
    try {
<span class="nc" id="L213">      articleRepository.merge(articleImage);</span>
<span class="nc" id="L214">      return Response.status(Response.Status.OK).build();</span>
<span class="nc" id="L215">    } catch (Exception e) {</span>
<span class="nc" id="L216">      return Response.status(Response.Status.BAD_REQUEST)</span>
<span class="nc" id="L217">          .entity(&quot;Failed to update article image: &quot; + e.getMessage())</span>
<span class="nc" id="L218">          .build();</span>
    }
  }

  @DELETE
  @Path(&quot;/api/delete-article-image/{uuid}&quot;)
  @Produces(MediaType.APPLICATION_JSON)
  public Response deleteArticleImage(@PathParam(&quot;uuid&quot;) String uuid) {
    try {
<span class="nc" id="L227">      articleRepository.deleteByArticleImageUuid(uuid);</span>
<span class="nc" id="L228">      return Response.status(Response.Status.OK).build();</span>
<span class="nc" id="L229">    } catch (Exception e) {</span>
<span class="nc" id="L230">      return Response.status(Response.Status.BAD_REQUEST)</span>
<span class="nc" id="L231">          .entity(&quot;Failed to delete article image: &quot; + e.getMessage())</span>
<span class="nc" id="L232">          .build();</span>
    }
  }

  /**
   * Render main page
   *
   * @return rendered main page
   */
  @GET
  public String index() {
<span class="nc" id="L243">    return &quot;list.xhtml&quot;;</span>
  }

  /**
   * Render detail page
   *
   * @return rendered detail page
   */
  @GET
  @Path(&quot;/detail&quot;)
  public String detail() {
<span class="nc" id="L254">    return &quot;detail.xhtml&quot;;</span>
  }

  /**
   * Redirect user to auth0 login page
   *
   * @return 303 to auth0 login page
   */
  @GET
  @Path(&quot;/login&quot;)
  public Response login(@Context HttpServletRequest request, @Context HttpServletResponse response)
      throws URISyntaxException {
<span class="nc" id="L266">    String callbackUrl = String.format(&quot;%s/callback&quot;, authController.getBaseURL(request));</span>

    // Create the authorization URL to redirect the user to, to begin the authentication flow.
<span class="nc" id="L269">    String authURL =</span>
        authenticationController
<span class="nc" id="L271">            .buildAuthorizeUrl(new JavaxRequest(request), new JavaxResponse(response), callbackUrl)</span>
<span class="nc" id="L272">            .withScope(config.getScope())</span>
<span class="nc" id="L273">            .build();</span>

<span class="nc" id="L275">    return Response.seeOther(new URI(authURL)).build();</span>
  }

  /**
   * Route to handle redirect from auth0 login
   *
   * @param request request
   * @param response response
   * @return 303 redirect to base url
   * @throws URISyntaxException URISyntaxException
   * @throws IdentityVerificationException IdentityVerificationException
   */
  @GET
  @Path(&quot;/callback&quot;)
  public Response callback(
      @Context HttpServletRequest request, @Context HttpServletResponse response)
      throws URISyntaxException, IdentityVerificationException {

    // extract email from given idToken
<span class="nc" id="L294">    Tokens tokens =</span>
<span class="nc" id="L295">        authenticationController.handle(new JavaxRequest(request), new JavaxResponse(response));</span>
<span class="nc" id="L296">    AuthController authController = new AuthController();</span>
<span class="nc" id="L297">    String idToken = tokens.getIdToken(); // JWT mit User-Claims</span>
<span class="nc" id="L298">    String email = authController.extractEmail(idToken);</span>
<span class="nc" id="L299">    String baseURL = authController.getBaseURL(request);</span>

    try {
<span class="nc" id="L302">      User emailConfirmed = repository.findByEmail(email);</span>

      // create entry if it doesn't exist (user is new)
<span class="nc bnc" id="L305" title="All 2 branches missed.">      if (emailConfirmed == null) {</span>
<span class="nc" id="L306">        emailConfirmed = new User();</span>
<span class="nc" id="L307">        emailConfirmed.setEmail(email);</span>
<span class="nc" id="L308">        emailConfirmed.setConfirmKey(UUID.randomUUID().toString());</span>
<span class="nc" id="L309">        repository.save(emailConfirmed);</span>

        // send email with generated confirm key allowing to identify the correct entry on
        // confirmation link
<span class="nc" id="L313">        new AuthMailSender().sendMail(emailConfirmed, baseURL);</span>
      }

      // store cookie with jwt in request to retrieve it from everywhere
<span class="nc" id="L317">      response.addCookie(new Cookie(&quot;jwt&quot;, idToken));</span>
<span class="nc" id="L318">    } catch (Exception e) {</span>
<span class="nc" id="L319">      Logger logger = Logger.getLogger(ApiController.class.getName());</span>
<span class="nc" id="L320">      logger.log(Level.SEVERE, e.getMessage());</span>
<span class="nc" id="L321">    }</span>

<span class="nc" id="L323">    return Response.seeOther(new URI(baseURL)).build();</span>
  }

  /**
   * Route for confirmation link setting confirmed = true on corresponding entry
   *
   * @param confirmKey: to identify databae entry
   * @return rendered confirmation page
   */
  @GET
  @Path(&quot;/confirm-email/{confirm-key}&quot;)
  public String confirmEmail(@PathParam(&quot;confirm-key&quot;) String confirmKey) {
<span class="nc" id="L335">    User emailConfirmed = repository.findByConfirmedKey(confirmKey);</span>
<span class="nc" id="L336">    emailConfirmed.setConfirmed(true);</span>
<span class="nc" id="L337">    repository.merge(emailConfirmed);</span>
<span class="nc" id="L338">    return &quot;emailConfirmed.xhtml&quot;;</span>
  }

  /**
   * Render shopping cart page
   *
   * @return rendered shopping cart page
   */
  @GET
  @Path(&quot;/shopping-cart&quot;)
  public String shoppingCart() {
<span class="nc" id="L349">    return &quot;shoppingCart.xhtml&quot;;</span>
  }

  /**
   * Add item to shopping-cart
   *
   * @param skuStr: article sku
   * @param amountStr: amount to add
   * @return re-render detail page
   */
  @POST
  @Path(&quot;/add-to-shopping-cart&quot;)
  @Transactional
  public Response addToShoppingCart(
      @FormParam(&quot;sku&quot;) String skuStr, @FormParam(&quot;amount&quot;) String amountStr) {

    try {
<span class="nc" id="L366">      long sku = Long.parseLong(skuStr);</span>
<span class="nc" id="L367">      long amount = Long.parseLong(amountStr);</span>
<span class="nc" id="L368">      String email = new AuthController().extractEmail(request);</span>

<span class="nc bnc" id="L370" title="All 2 branches missed.">      if (email == null) {</span>
<span class="nc" id="L371">        return Response.status(Response.Status.UNAUTHORIZED).build();</span>
      }

<span class="nc" id="L374">      ShoppingCart shoppingCart =</span>
<span class="nc" id="L375">          shoppingCartController.getOrUpdateShoppingCart(sku, amount, email);</span>
<span class="nc" id="L376">      shoppingCartRepository.merge(shoppingCart);</span>

<span class="nc" id="L378">      return Response.seeOther(</span>
              new URI(
<span class="nc" id="L380">                  String.format(&quot;%s/detail?sku=%s&quot;, authController.getBaseURL(request), skuStr)))</span>
<span class="nc" id="L381">          .build();</span>
<span class="nc" id="L382">    } catch (Exception ignored) {</span>
    }

<span class="nc" id="L385">    return Response.status(Status.BAD_REQUEST).build();</span>
  }

  /**
   * Change amount in shopping cart
   *
   * @param amountStr: amount to be set
   * @param skuStr: article sku
   * @return 200 when finished
   */
  @POST
  @Path(&quot;/shopping-cart/change-amount/{sku}/{amount}&quot;)
  public Response changeAmount(
      @PathParam(&quot;amount&quot;) String amountStr, @PathParam(&quot;sku&quot;) String skuStr) {
<span class="nc" id="L399">    long sku = Long.parseLong(skuStr);</span>
<span class="nc" id="L400">    String email = new AuthController().extractEmail(request);</span>

<span class="nc bnc" id="L402" title="All 2 branches missed.">    if (email == null) {</span>
<span class="nc" id="L403">      return Response.status(Response.Status.UNAUTHORIZED).build();</span>
    }

<span class="nc" id="L406">    ShoppingCart shoppingCart = shoppingCartRepository.findBySkuAndEmail(sku, email);</span>
<span class="nc" id="L407">    shoppingCart.setAmount(shoppingCartController.getMaxAmount(Long.parseLong(amountStr), shoppingCart));</span>
<span class="nc" id="L408">    shoppingCartRepository.merge(shoppingCart);</span>

<span class="nc" id="L410">    return Response.ok().build();</span>
  }

  /**
   * Delete entry from shopping cart
   *
   * @param entryUuidStr uuid of shopping cart database entry
   * @return 200 when finished
   */
  @DELETE
  @Path(&quot;/shopping-cart/delete-entry/{uuid}&quot;)
  public Response deleteEntry(@PathParam(&quot;uuid&quot;) String entryUuidStr) {
<span class="nc" id="L422">    String email = new AuthController().extractEmail(request);</span>

<span class="nc bnc" id="L424" title="All 2 branches missed.">    if (email == null) {</span>
<span class="nc" id="L425">      return Response.status(Response.Status.UNAUTHORIZED).build();</span>
    }

<span class="nc" id="L428">    shoppingCartRepository.deleteByUuid(entryUuidStr);</span>

<span class="nc" id="L430">    return Response.ok().build();</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>